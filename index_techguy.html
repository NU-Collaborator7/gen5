<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AIãƒãƒ£ãƒƒãƒˆ(Tech Guy)</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700&family=Kosugi+Maru&display=swap" rel="stylesheet">
    <style>
    /* --- æ—¢å­˜ã®ãƒ‡ã‚¶ã‚¤ãƒ³ã‚’ç¶­æŒ --- */
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
        font-family: 'Noto Sans JP', 'Helvetica Neue', Arial, sans-serif;
        background: radial-gradient(circle at 50% 50%, #fdfbf7 0%, #f2e9e1 100%);
        height: 100vh; display: flex; justify-content: center; align-items: center; padding: 10px;
    }
    .chat-container {
        width: 100%; max-width: 850px; height: 92vh; background: #ffffff;
        border-radius: 24px; box-shadow: 0 20px 60px rgba(0,0,0,0.1);
        display: flex; flex-direction: column; overflow: hidden; border: 1px solid rgba(0,0,0,0.05);
    }
    .chat-header {
        background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
        color: #fff; padding: 18px 24px; display:flex; align-items:center; gap:15px;
        border-bottom: 4px solid #e67e22;
    }
    .chat-header .title-emoji { font-size: 32px; background: rgba(255,255,255,0.1); padding: 5px; border-radius: 50%; }
    .chat-header .title-text { font-size: 22px; font-weight: 700; }
    
    .profile-selector { padding: 10px 20px; background: #fdfcfb; border-bottom: 1px solid #eee; display: flex; gap: 10px; align-items: center; }
    
    /* --- è¿½åŠ /ä¿®æ­£ã—ãŸã‚¹ã‚¿ã‚¤ãƒ« --- */
    #customProfileContainer {
        padding: 15px 20px;
        background: #fdfcfb;
        border-bottom: 1px solid #eee;
        display: none; /* åˆæœŸçŠ¶æ…‹ã¯éè¡¨ç¤º */
        animation: slideDown 0.3s ease-out;
    }
    @keyframes slideDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
    
    .custom-textarea {
        width: 100%;
        height: 100px;
        padding: 12px;
        border-radius: 12px;
        border: 2px solid #e1e8ed;
        font-family: inherit;
        font-size: 14px;
        resize: none;
        outline: none;
        transition: border-color 0.2s;
    }
    .custom-textarea:focus { border-color: #e67e22; }

    .form-select { padding: 6px 12px; border-radius: 10px; border: 1px solid #ddd; }
    .voice-status { font-size: 12px; color: #e67e22; margin-left: auto; font-weight: bold; }

    .chat-messages { flex:1; overflow-y:auto; padding:25px; display:flex; flex-direction:column; gap:18px; background-image: radial-gradient(#eee 1px, transparent 1px); background-size: 20px 20px; }
    .message { max-width:85%; padding:16px 20px; border-radius:18px; word-wrap:break-word; line-height: 1.6; animation: fadeIn 0.3s ease-out; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
    .message.user { background: #e67e22; color: #fff; align-self: flex-end; border-bottom-right-radius: 4px; }
    .message.assistant { background: #f0f4f8; color: #34495e; align-self: flex-start; border-bottom-left-radius: 4px; border: 1px solid #e1e8ed; }
    
    .chat-input-container { padding:20px; background:#fff; border-top: 1px solid #eee; display:flex; gap:12px; }
    .chat-input { flex:1; padding:14px 20px; border:2px solid #e1e8ed; border-radius:30px; outline:none; }
    .send-button { padding:12px 28px; background: #2c3e50; color:#fff; border:none; border-radius:30px; font-weight:700; cursor:pointer; }
    .play-button { padding:5px 12px; background: rgba(44, 62, 80, 0.05); color: #2c3e50; border: 1px solid rgba(44, 62, 80, 0.1); border-radius:8px; font-size:11px; cursor:pointer; margin-top:10px; display: block; }
    .play-button.playing { background:#e74c3c; color:#fff; }
    .typing-indicator { display:flex; gap:5px; padding:10px 15px; }
    .typing-indicator span { width:6px; height:6px; background:#2c3e50; border-radius:50%; animation:bounce 1.4s infinite; opacity:0.3; }
    @keyframes bounce { 0%,60%,100%{ transform:translateY(0);} 30%{ transform:translateY(-5px);} }
    .load-status { font-size: 12px; color: #27ae60; font-weight: bold; }
</style>
</head>
<body>
    <div class="chat-container">
        <div class="chat-header">
            <div class="title-emoji">ğŸ˜ƒ</div>
            <div class="title-text">è‡ªåˆ†ã®ã‚ªãƒªã‚¸ãƒŠãƒ«AIã‚’ä½œã‚Œã‚‹</div>
        </div>
        
        <div class="profile-selector">
            <select id="profileSelect" class="form-select">
                <option value="RAG/profile_1.txt" selected>Profile_1</option>
                <option value="RAG/profile_2.txt">Profile_2</option>
                <option value="custom">è‡ªåˆ†ã®ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚’ä½œã‚‹</option>
            </select>
            <div id="loadStatus" class="load-status"></div>
            <div id="voiceStatus" class="voice-status"></div>
        </div>

        <div id="customProfileContainer">
            <textarea id="customProfileText" class="custom-textarea" placeholder="ã“ã“ã«ä½œã‚ŠãŸã„ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã®è¨­å®šã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚"></textarea>
        </div>

        <div class="chat-messages" id="messages"></div>
        
        <div class="chat-input-container">
            <input type="text" class="chat-input" id="input" placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›..." autocomplete="off" />
            <button class="send-button" id="send">é€ä¿¡</button>
        </div>
    </div>

    <script src="https://js.puter.com/v2/"></script>
    <script>
        const messagesDiv = document.getElementById('messages');
        const inputField = document.getElementById('input');
        const sendButton = document.getElementById('send');
        const voiceStatus = document.getElementById('voiceStatus');
        const loadStatus = document.getElementById('loadStatus');
        const profileSelect = document.getElementById('profileSelect');
        const customContainer = document.getElementById('customProfileContainer');
        const customTextArea = document.getElementById('customProfileText');

        let isProcessing = false;
        let charaData = ""; 
        let conversationHistory = [];
        let selectedModel = 'gemini-2.0-flash';

        // ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿
        async function loadCharaData() {
            const selectedValue = profileSelect.value;
            
            if (selectedValue === 'custom') {
                // ã‚«ã‚¹ã‚¿ãƒ å…¥åŠ›æ¬„ã‚’è¡¨ç¤º
                customContainer.style.display = 'block';
                // ã‚«ã‚¹ã‚¿ãƒ ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ã®å†…å®¹ã‚’ã‚»ãƒƒãƒˆ
                charaData = customTextArea.value.trim();
                if (charaData) {
                    loadStatus.textContent = 'âœ“ ã‚«ã‚¹ã‚¿ãƒ è¨­å®šèª­ã¿è¾¼ã¿å®Œäº†';
                    setTimeout(() => loadStatus.textContent = '', 2000);
                } else {
                    loadStatus.textContent = 'âš  ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼è¨­å®šã‚’å…¥åŠ›ã—ã¦ãã ã•ã„';
                }
            } else {
                // ã‚«ã‚¹ã‚¿ãƒ å…¥åŠ›æ¬„ã‚’éè¡¨ç¤º
                customContainer.style.display = 'none';
                // ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰èª­ã¿è¾¼ã¿
                try {
                    loadStatus.textContent = 'èª­ã¿è¾¼ã¿ä¸­...';
                    const response = await fetch(selectedValue);
                    if (!response.ok) throw new Error('èª­ã¿è¾¼ã¿ã«å¤±æ•—');
                    charaData = await response.text();
                    loadStatus.textContent = 'âœ“ èª­ã¿è¾¼ã¿å®Œäº†';
                    setTimeout(() => loadStatus.textContent = '', 2000);
                } catch (error) {
                    console.error('èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
                    loadStatus.textContent = 'âœ— èª­ã¿è¾¼ã¿å¤±æ•—';
                    setTimeout(() => loadStatus.textContent = '', 3000);
                }
            }
        }

        // ã‚»ãƒ¬ã‚¯ãƒˆãƒœãƒƒã‚¯ã‚¹ã®å¤‰æ›´ã‚’æ¤œçŸ¥ã—ã¦è‡ªå‹•èª­ã¿è¾¼ã¿
        profileSelect.addEventListener('change', loadCharaData);

        // ã‚«ã‚¹ã‚¿ãƒ ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ã®å†…å®¹ãŒå¤‰æ›´ã•ã‚ŒãŸã‚‰è‡ªå‹•çš„ã«charaDataã«åæ˜ 
        customTextArea.addEventListener('input', () => {
            if (profileSelect.value === 'custom') {
                charaData = customTextArea.value.trim();
            }
        });

        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«profile_1ã‚’è‡ªå‹•èª­ã¿è¾¼ã¿
        window.addEventListener('load', loadCharaData);

        // --- éŸ³å£°ãƒ»ãƒãƒ£ãƒƒãƒˆå‡¦ç† ---
        function stopAllSpeech() {
            window.speechSynthesis.cancel();
            voiceStatus.textContent = '';
            document.querySelectorAll('.play-button').forEach(btn => {
                btn.textContent = 'â–¶ï¸ éŸ³å£°ã‚’å†ç”Ÿã™ã‚‹';
                btn.classList.remove('playing');
            });
        }

        function speakText(text, button) {
            stopAllSpeech();
            button.textContent = 'â¸ï¸ åœæ­¢';
            button.classList.add('playing');
            const cleanText = text.replace(/[*#]/g, '').trim();
            const utterance = new SpeechSynthesisUtterance(cleanText);
            utterance.lang = 'ja-JP';
            utterance.rate = 1.1;
            utterance.pitch = 0.9;
            utterance.onstart = () => { voiceStatus.textContent = 'ğŸ¤ èª­ã¿ä¸Šã’ä¸­...'; };
            utterance.onend = () => {
                button.textContent = 'â–¶ï¸ éŸ³å£°ã‚’å†ç”Ÿã™ã‚‹';
                button.classList.remove('playing');
                voiceStatus.textContent = '';
            };
            window.speechSynthesis.speak(utterance);
        }

        function addMessage(text, isUser) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${isUser ? 'user' : 'assistant'}`;
            messageDiv.innerHTML = text.replaceAll('\n', '<br>');
            if (!isUser && text) {
                const playButton = document.createElement('button');
                playButton.className = 'play-button';
                playButton.textContent = 'â–¶ï¸ éŸ³å£°ã‚’å†ç”Ÿã™ã‚‹';
                playButton.onclick = () => speakText(text, playButton);
                messageDiv.appendChild(playButton);
            }
            messagesDiv.appendChild(messageDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
            return messageDiv;
        }

        async function sendMessage() {
            if (isProcessing) return;
            const userText = inputField.value.trim();
            if (!userText) return;

            isProcessing = true;
            sendButton.disabled = true;
            addMessage(userText, true);
            inputField.value = '';

            const fullPrompt = charaData ? `ä»¥ä¸‹ã®è¨­å®šã«å¾“ã£ã¦å›ç­”ã—ã¦ãã ã•ã„ã€‚\nè¨­å®š:\n${charaData}\n\nãƒ¦ãƒ¼ã‚¶ãƒ¼: ${userText}` : userText;
            conversationHistory.push({ role: 'user', content: fullPrompt });

            const indicator = document.createElement('div');
            indicator.className = 'message assistant typing-indicator';
            indicator.innerHTML = '<span></span><span></span><span></span>';
            messagesDiv.appendChild(indicator);

            try {
                const chatResp = await puter.ai.chat(conversationHistory, { model: selectedModel, stream: true });
                indicator.remove();
                
                let assistantMessage = addMessage('', false);
                let fullResponse = '';

                for await (const part of chatResp) {
                    if (part?.text) {
                        fullResponse += part.text;
                        
                        // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å†…å®¹ã®æ›´æ–°ï¼ˆãƒœã‚¿ãƒ³ã‚’ä¿æŒã—ã¤ã¤ãƒ†ã‚­ã‚¹ãƒˆã‚’æ›¸ãæ›ãˆã‚‹ï¼‰
                        assistantMessage.innerHTML = fullResponse.replaceAll('\n', '<br>');
                        const playBtn = document.createElement('button');
                        playBtn.className = 'play-button';
                        playBtn.textContent = 'â–¶ï¸ éŸ³å£°ã‚’å†ç”Ÿã™ã‚‹';
                        playBtn.onclick = () => speakText(fullResponse, playBtn);
                        assistantMessage.appendChild(playBtn);

                        messagesDiv.scrollTop = messagesDiv.scrollHeight;
                    }
                }
                conversationHistory.push({ role: 'assistant', content: fullResponse });
            } catch (error) {
                if (indicator) indicator.remove();
                addMessage('ã‚¨ãƒ©ãƒ¼: ' + error.message, false);
            }
            isProcessing = false;
            sendButton.disabled = false;
        }

        sendButton.addEventListener('click', sendMessage);
        inputField.addEventListener('keypress', (e) => { if (e.key === 'Enter') sendMessage(); });
    </script>
</body>
</html>
