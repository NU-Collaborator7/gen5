<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AIãƒãƒ£ãƒƒãƒˆï¼ˆè‡ªåˆ†ã®ã‚ªãƒªã‚¸ãƒŠãƒ«AIã‚’ä½œã‚ã†ã€‚ï¼‰</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700&family=Kosugi+Maru&display=swap" rel="stylesheet">
    <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
        font-family: 'Noto Sans JP', 'Helvetica Neue', Arial, sans-serif;
        background: radial-gradient(circle at 50% 50%, #fdfbf7 0%, #f2e9e1 100%);
        height: 100vh; display: flex; justify-content: center; align-items: center; padding: 10px;
    }
    .chat-container {
        width: 100%; max-width: 850px; height: 92vh; background: #ffffff;
        border-radius: 24px; box-shadow: 0 20px 60px rgba(0,0,0,0.1);
        display: flex; flex-direction: column; overflow: hidden; border: 1px solid rgba(0,0,0,0.05);
    }
    .chat-header {
        background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
        color: #fff; padding: 18px 24px; display:flex; align-items:center; gap:15px;
        border-bottom: 4px solid #e67e22;
    }
    .chat-header .title-emoji { font-size: 32px; background: rgba(255,255,255,0.1); padding: 5px; border-radius: 50%; }
    .chat-header .title-text { font-size: 22px; font-weight: 700; }
    
    .profile-selector { 
        padding: 10px 20px; background: #fdfcfb; border-bottom: 1px solid #eee; 
        display: flex; gap: 10px; align-items: center; flex-wrap: wrap;
    }
    
    #customProfileContainer {
        padding: 15px 20px;
        background: #fdfcfb;
        border-bottom: 1px solid #eee;
        display: none;
        animation: slideDown 0.3s ease-out;
    }
    @keyframes slideDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
    
    .custom-textarea {
        width: 100%;
        height: 100px;
        padding: 12px;
        border-radius: 12px;
        border: 2px solid #e1e8ed;
        font-family: inherit;
        font-size: 14px;
        resize: none;
        outline: none;
        transition: border-color 0.2s;
    }
    .custom-textarea:focus { border-color: #e67e22; }

    .form-select { padding: 6px 12px; border-radius: 10px; border: 1px solid #ddd; }
    .voice-status { font-size: 12px; color: #e67e22; margin-left: auto; font-weight: bold; }
    .load-status { font-size: 12px; color: #27ae60; font-weight: bold; }

    .chat-messages { flex:1; overflow-y:auto; padding:25px; display:flex; flex-direction:column; gap:18px; background-image: radial-gradient(#eee 1px, transparent 1px); background-size: 20px 20px; }
    .message { max-width:85%; padding:16px 20px; border-radius:18px; word-wrap:break-word; line-height: 1.6; animation: fadeIn 0.3s ease-out; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
    .message.user { background: #e67e22; color: #fff; align-self: flex-end; border-bottom-right-radius: 4px; }
    .message.assistant { background: #f0f4f8; color: #34495e; align-self: flex-start; border-bottom-left-radius: 4px; border: 1px solid #e1e8ed; }
    
    .chat-input-container { padding:20px; background:#fff; border-top: 1px solid #eee; display:flex; gap:12px; }
    .chat-input { flex:1; padding:14px 20px; border:2px solid #e1e8ed; border-radius:30px; outline:none; }
    .send-button { padding:12px 28px; background: #2c3e50; color:#fff; border:none; border-radius:30px; font-weight:700; cursor:pointer; }
    .play-button { padding:5px 12px; background: rgba(44, 62, 80, 0.05); color: #2c3e50; border: 1px solid rgba(44, 62, 80, 0.1); border-radius:8px; font-size:11px; cursor:pointer; margin-top:10px; display: block; }
    .play-button.playing { background:#e74c3c; color:#fff; }
    .typing-indicator { display:flex; gap:5px; padding:10px 15px; }
    .typing-indicator span { width:6px; height:6px; background:#2c3e50; border-radius:50%; animation:bounce 1.4s infinite; opacity:0.3; }
    @keyframes bounce { 0%,60%,100%{ transform:translateY(0);} 30%{ transform:translateY(-5px);} }
</style>
</head>
<body>
    <div class="chat-container">
        <div class="chat-header">
            <div class="title-emoji">ğŸ˜ƒ</div>
            <div class="title-text">è‡ªåˆ†ã®ã‚ªãƒªã‚¸ãƒŠãƒ«AIã‚’ä½œã‚Œã‚‹</div>
        </div>
        
        <div class="profile-selector">
            <select id="profileSelect" class="form-select">
                <option value="RAG/profile_1.txt" selected>Profile_1</option>
                <option value="RAG/profile_2.txt">Profile_2</option>
                <option value="custom">è‡ªåˆ†ã®ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚’ä½œã‚‹</option>
            </select>
            <select id="voiceSelect" class="form-select">
                <option value="auto">éŸ³å£°: è‡ªå‹•</option>
                <option value="male">éŸ³å£°: ç”·æ€§</option>
                <option value="female">éŸ³å£°: å¥³æ€§</option>
                <option value="ballad">ãƒªã‚¢ãƒ«éŸ³å£°ï¼ˆAndroid/Windows/iPad/macBookï¼‰</option>
            </select>
            <div id="loadStatus" class="load-status"></div>
            <div id="voiceStatus" class="voice-status"></div>
        </div>

        <div id="customProfileContainer">
            <textarea id="customProfileText" class="custom-textarea" placeholder="ã“ã“ã«ä½œã‚ŠãŸã„ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã®è¨­å®šã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚ãã®ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã®AIãŒå›ç­”ã—ã¦ãã‚Œã¾ã™ã€‚"></textarea>
        </div>

        <div class="chat-messages" id="messages"></div>
        
        <div class="chat-input-container">
            <input type="text" class="chat-input" id="input" placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›..." autocomplete="off" />
            <button class="send-button" id="send">é€ä¿¡</button>
        </div>
    </div>

    <script src="https://js.puter.com/v2/"></script>
    <script>
        const messagesDiv = document.getElementById('messages');
        const inputField = document.getElementById('input');
        const sendButton = document.getElementById('send');
        const voiceStatus = document.getElementById('voiceStatus');
        const loadStatus = document.getElementById('loadStatus');
        const profileSelect = document.getElementById('profileSelect');
        const voiceSelect = document.getElementById('voiceSelect');
        const customContainer = document.getElementById('customProfileContainer');
        const customTextArea = document.getElementById('customProfileText');

        let isProcessing = false;
        let charaData = ""; 
        let conversationHistory = [];
        let selectedModel = 'gemini-2.0-flash';
        let availableVoices = [];

        // éŸ³å£°ãƒªã‚¹ãƒˆã‚’èª­ã¿è¾¼ã‚€
        function loadVoices() {
            availableVoices = window.speechSynthesis.getVoices();
        }

        // éŸ³å£°ãƒªã‚¹ãƒˆãŒèª­ã¿è¾¼ã¾ã‚Œã‚‹ã¾ã§å¾…ã¤
        if (window.speechSynthesis.onvoiceschanged !== undefined) {
            window.speechSynthesis.onvoiceschanged = loadVoices;
        }
        loadVoices();

        // é¸æŠã•ã‚ŒãŸéŸ³å£°ã‚¿ã‚¤ãƒ—ã«åŸºã¥ã„ã¦æœ€é©ãªéŸ³å£°ã‚’å–å¾—
        function getSelectedVoice() {
            const voiceType = voiceSelect.value;
            const jaVoices = availableVoices.filter(v => v.lang.includes('ja'));
            
            if (voiceType === 'male') {
                return jaVoices.find(v => 
                    v.name.includes('Male') || 
                    v.name.includes('ç”·æ€§') ||
                    v.name.includes('Ichiro') ||
                    v.name.includes('Otoya')
                ) || jaVoices[0];
            } else if (voiceType === 'female') {
                return jaVoices.find(v => 
                    v.name.includes('Female') || 
                    v.name.includes('å¥³æ€§') ||
                    v.name.includes('Ayumi') ||
                    v.name.includes('Kyoko')
                ) || jaVoices[0];
            }
            
            return jaVoices[0];
        }

        // ç¾åœ¨ã®æ—¥æ™‚ã‚’å–å¾—ã™ã‚‹é–¢æ•°ï¼ˆå‚è€ƒHTMLã®ãƒ­ã‚¸ãƒƒã‚¯ï¼‰
        function getCurrentDateTime() {
            const now = new Date();
            const options = { 
                timeZone: 'Asia/Tokyo',
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                weekday: 'long',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            };
            return now.toLocaleString('ja-JP', options);
        }

        // ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿
        async function loadCharaData() {
            const selectedValue = profileSelect.value;
            
            if (selectedValue === 'custom') {
                customContainer.style.display = 'block';
                charaData = customTextArea.value.trim();
                if (charaData) {
                    loadStatus.textContent = 'âœ“ ã‚«ã‚¹ã‚¿ãƒ è¨­å®šèª­ã¿è¾¼ã¿å®Œäº†';
                    setTimeout(() => loadStatus.textContent = '', 2000);
                } else {
                    loadStatus.textContent = 'âš  ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼è¨­å®šã‚’å…¥åŠ›ã—ã¦ãã ã•ã„';
                }
            } else {
                customContainer.style.display = 'none';
                try {
                    loadStatus.textContent = 'èª­ã¿è¾¼ã¿ä¸­...';
                    const response = await fetch(selectedValue);
                    if (!response.ok) throw new Error('èª­ã¿è¾¼ã¿ã«å¤±æ•—');
                    charaData = await response.text();
                    loadStatus.textContent = 'âœ“ èª­ã¿è¾¼ã¿å®Œäº†';
                    setTimeout(() => loadStatus.textContent = '', 2000);
                } catch (error) {
                    console.error('èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
                    loadStatus.textContent = 'âœ— èª­ã¿è¾¼ã¿å¤±æ•—';
                    setTimeout(() => loadStatus.textContent = '', 3000);
                }
            }
        }

        profileSelect.addEventListener('change', loadCharaData);

        customTextArea.addEventListener('input', () => {
            if (profileSelect.value === 'custom') {
                charaData = customTextArea.value.trim();
            }
        });

        window.addEventListener('load', loadCharaData);

        // éŸ³å£°é–¢é€£å‡¦ç†
        function stopAllSpeech() {
            window.speechSynthesis.cancel();
            voiceStatus.textContent = '';
            document.querySelectorAll('.play-button').forEach(btn => {
                btn.textContent = 'â–¶ï¸ éŸ³å£°ã‚’å†ç”Ÿã™ã‚‹';
                btn.classList.remove('playing');
            });
        }

        // ãƒ–ãƒ©ã‚¦ã‚¶éŸ³å£°ã§å†ç”Ÿ
        function speakText(text, button) {
            stopAllSpeech();
            button.textContent = 'â¸ï¸ åœæ­¢';
            button.classList.add('playing');
            
            const cleanText = text.replace(/[*#]/g, '').trim();
            const utterance = new SpeechSynthesisUtterance(cleanText);
            
            const selectedVoice = getSelectedVoice();
            if (selectedVoice) {
                utterance.voice = selectedVoice;
            }
            
            utterance.lang = 'ja-JP';
            utterance.rate = 1.1;
            
            const voiceType = voiceSelect.value;
            if (voiceType === 'female') {
                utterance.pitch = 1.2;
            } else if (voiceType === 'male') {
                utterance.pitch = 0.9;
            } else {
                utterance.pitch = 1.0;
            }
            
            utterance.onstart = () => { 
                const voiceTypeText = voiceType === 'male' ? 'ç”·æ€§' : voiceType === 'female' ? 'å¥³æ€§' : 'è‡ªå‹•';
                voiceStatus.textContent = `ğŸ¤ èª­ã¿ä¸Šã’ä¸­... (${voiceTypeText})`; 
            };
            
            utterance.onend = () => {
                button.textContent = 'â–¶ï¸ éŸ³å£°ã‚’å†ç”Ÿã™ã‚‹';
                button.classList.remove('playing');
                voiceStatus.textContent = '';
            };
            
            window.speechSynthesis.speak(utterance);
        }

        // ãƒªã‚¢ãƒ«éŸ³å£°ï¼ˆballadï¼‰ã§å†ç”Ÿ
        async function speakViaPuter(text, button) {
            if (!text) return;
            stopAllSpeech();
            button.textContent = 'ğŸ“¢ ç”Ÿæˆä¸­...';
            button.classList.add('playing');
            voiceStatus.textContent = 'ğŸ¤ ãƒªã‚¢ãƒ«éŸ³å£°ç”Ÿæˆä¸­...';

            let cleanText = text
                .replace(/\*\*/g, '')
                .replace(/\*/g, '')
                .replace(/#{1,6}\s/g, '')
                .replace(/:/g, '')
                .replace(/[\u{1F600}-\u{1F64F}]/gu, '')
                .replace(/[\u{1F300}-\u{1F5FF}]/gu, '')
                .replace(/[\u{1F680}-\u{1F6FF}]/gu, '')
                .replace(/[\u{1F1E0}-\u{1F1FF}]/gu, '')
                .replace(/[\u{2600}-\u{26FF}]/gu, '')
                .replace(/[\u{2700}-\u{27BF}]/gu, '')
                .replace(/[\u{1F900}-\u{1F9FF}]/gu, '')
                .replace(/[\u{1FA00}-\u{1FA6F}]/gu, '')
                .replace(/[\u{1FA70}-\u{1FAFF}]/gu, '');

            try {
                const audio = await puter.ai.txt2speech(cleanText, {
                    provider: 'openai',
                    model: 'tts-1',
                    response_format: 'aac',
                    voice: 'ballad',
                    language: 'ja'
                });

                voiceStatus.textContent = 'â–¶ï¸ å†ç”Ÿä¸­...';
                await audio.play();

                audio.onended = () => {
                    button.textContent = 'â–¶ï¸ éŸ³å£°ã‚’å†ç”Ÿã™ã‚‹';
                    button.classList.remove('playing');
                    voiceStatus.textContent = '';
                };
            } catch (err) {
                console.error('ãƒªã‚¢ãƒ«éŸ³å£°å†ç”Ÿã‚¨ãƒ©ãƒ¼:', err);
                voiceStatus.textContent = 'âš ï¸ éŸ³å£°ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ';
                button.textContent = 'â–¶ï¸ éŸ³å£°ã‚’å†ç”Ÿã™ã‚‹';
                button.classList.remove('playing');
            }
        }

        function addMessage(text, isUser) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${isUser ? 'user' : 'assistant'}`;
            messageDiv.innerHTML = text.replaceAll('\n', '<br>');
            if (!isUser && text) {
                const playButton = document.createElement('button');
                playButton.className = 'play-button';
                playButton.textContent = 'â–¶ï¸ éŸ³å£°ã‚’å†ç”Ÿã™ã‚‹';
                playButton.onclick = () => {
                    const voiceType = voiceSelect.value;
                    if (voiceType === 'ballad') {
                        speakViaPuter(text, playButton);
                    } else {
                        speakText(text, playButton);
                    }
                };
                messageDiv.appendChild(playButton);
            }
            messagesDiv.appendChild(messageDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
            return messageDiv;
        }

        async function sendMessage() {
            if (isProcessing) return;
            const userText = inputField.value.trim();
            if (!userText) return;

            isProcessing = true;
            sendButton.disabled = true;
            addMessage(userText, true);
            inputField.value = '';

            // ç¾åœ¨ã®æ—¥æ™‚ã‚’å–å¾—
            const profiling_time = getCurrentDateTime();

            // ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‡ãƒ¼ã‚¿ã¨ç¾åœ¨æ™‚åˆ»ã‚’çµåˆã—ã¦ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ä½œæˆ
            const fullPrompt = charaData 
                ? `ä»¥ä¸‹ã®è¨­å®šã«å¾“ã£ã¦å›ç­”ã—ã¦ãã ã•ã„ã€‚\nè¨­å®š:\n${charaData}\n\nãƒ¦ãƒ¼ã‚¶ãƒ¼: ${userText}\n\nç¾åœ¨ã®æ—¥æ™‚: ${profiling_time}` 
                : `${userText}\n\nç¾åœ¨ã®æ—¥æ™‚: ${profiling_time}`;
            
            conversationHistory.push({ role: 'user', content: fullPrompt });

            const indicator = document.createElement('div');
            indicator.className = 'message assistant typing-indicator';
            indicator.innerHTML = '<span></span><span></span><span></span>';
            messagesDiv.appendChild(indicator);

            try {
                const chatResp = await puter.ai.chat(conversationHistory, { model: selectedModel, stream: true });
                indicator.remove();
                
                let assistantMessage = addMessage('', false);
                let fullResponse = '';

                for await (const part of chatResp) {
                    if (part?.text) {
                        fullResponse += part.text;
                        
                        assistantMessage.innerHTML = fullResponse.replaceAll('\n', '<br>');
                        const playBtn = document.createElement('button');
                        playBtn.className = 'play-button';
                        playBtn.textContent = 'â–¶ï¸ éŸ³å£°ã‚’å†ç”Ÿã™ã‚‹';
                        playBtn.onclick = () => {
                            const voiceType = voiceSelect.value;
                            if (voiceType === 'ballad') {
                                speakViaPuter(fullResponse, playBtn);
                            } else {
                                speakText(fullResponse, playBtn);
                            }
                        };
                        assistantMessage.appendChild(playBtn);

                        messagesDiv.scrollTop = messagesDiv.scrollHeight;
                    }
                }
                conversationHistory.push({ role: 'assistant', content: fullResponse });
            } catch (error) {
                if (indicator) indicator.remove();
                addMessage('ã‚¨ãƒ©ãƒ¼: ' + error.message, false);
            }
            isProcessing = false;
            sendButton.disabled = false;
        }

        sendButton.addEventListener('click', sendMessage);
        inputField.addEventListener('keypress', (e) => { if (e.key === 'Enter') sendMessage(); });
    </script>
</body>
</html>