<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è™ãŠã£ã•ã‚“ï¼ˆãƒªã‚¢ãƒ«éŸ³å£°ç‰ˆï¼‰</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700&family=Kosugi+Maru&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Noto Sans JP', 'Kosugi Maru', sans-serif;
            background: radial-gradient(circle at 10% 10%, rgba(0,0,0,0.06), transparent 20%), #f6f0e6;
            height: 100vh; display: flex; justify-content: center; align-items: center; padding: 10px;
        }
        .chat-container {
            width: 98%; max-width: 820px; height: 90vh; background: linear-gradient(180deg,#fffaf0,#fff7e6);
            border-radius: 18px; box-shadow: 0 18px 50px rgba(0,0,0,0.35);
            display: flex; flex-direction: column; overflow: hidden; border: 6px solid #f6c100;
        }
        .chat-header {
            background-image: repeating-linear-gradient( -25deg, rgba(0,0,0,0.85) 0 18px, #f6c100 18px 36px );
            color: #fff; padding: 14px 20px; font-size: 20px; font-weight: 700; display:flex; align-items:center; gap:12px;
        }
        .voice-controls { display:flex; gap:10px; align-items:center; padding:12px 16px; background:#fff3d1; border-top:1px solid rgba(0,0,0,0.06); }
        .language-select { padding:8px 14px; border-radius:18px; border:2px solid #000; font-weight:700; }
        .chat-messages { flex:1; overflow-y:auto; padding:20px; display:flex; flex-direction:column; gap:14px; background-image: repeating-linear-gradient(90deg, rgba(0,0,0,0.02) 0 2px, transparent 2px 40px ); }
        .message { max-width:75%; padding:14px 16px; border-radius:14px; word-wrap:break-word; box-shadow: 0 4px 12px rgba(0,0,0,0.05); position: relative; }
        .message.user { background: #f6c100; color: #000; align-self:flex-end; border-bottom-right-radius:2px; font-weight:700; }
        .message.assistant { background: #fff; color:#111; align-self:flex-start; border-bottom-left-radius:2px; border:1px solid #ddd; }
        .chat-input-container { padding:16px; background:#fff7e6; border-top:6px solid #f6c100; display:flex; gap:10px; }
        .chat-input { flex:1; padding:12px 16px; border:2px solid #000; border-radius:24px; font-size:16px; }
        .send-button { padding:12px 24px; background:#000; color:#f6c100; border:none; border-radius:24px; font-weight:800; cursor:pointer; }
        .play-button { display: block; margin-top: 8px; padding: 4px 12px; background: #f6c100; border: none; border-radius: 8px; font-size: 12px; cursor: pointer; font-weight: bold; }
        .play-button.playing { background: #ff5722; color: #fff; }
        .typing-indicator { display:flex; gap:4px; padding:10px; }
        .typing-indicator span { width:8px; height:8px; background:#aaa; border-radius:50%; animation:bounce 1.3s infinite; }
        @keyframes bounce { 0%,60%,100%{transform:translateY(0)} 30%{transform:translateY(-6px)} }
    </style>
</head>
<body>
    <div class="chat-container">
        <div class="chat-header">ğŸ¯ <span class="title-text">è™ãŠã£ã•ã‚“ï¼ˆãƒªã‚¢ãƒ«éŸ³å£°ç‰ˆï¼‰</span></div>
        <div class="voice-controls">
            <select class="language-select" id="voiceSelect">
                <option value="default">æ¨™æº–éŸ³å£°ï¼ˆãƒ–ãƒ©ã‚¦ã‚¶ï¼‰</option>
                <option value="onyx">ãƒªã‚¢ãƒ«éŸ³å£° (Onyx)</option>
                <option value="off" selected>éŸ³å£°ã‚ªãƒ•</option>
            </select>
            <span id="voiceStatus" style="font-size:12px;"></span>
        </div>
        <div class="chat-messages" id="messages"></div>
        <div class="chat-input-container">
            <input type="text" class="chat-input" id="input" placeholder="ãŠã£ã•ã‚“ã«ä½•ã‹è¨€ã†ã¦ã‚„..." autocomplete="off">
            <button class="send-button" id="send">é€ä¿¡</button>
        </div>
    </div>

    <script src="https://js.puter.com/v2/"></script>
    <script>
        const messagesDiv = document.getElementById('messages');
        const inputField = document.getElementById('input');
        const sendButton = document.getElementById('send');
        const voiceSelect = document.getElementById('voiceSelect');
        const voiceStatus = document.getElementById('voiceStatus');

        let isProcessing = false;
        let conversationHistory = [];
        let the_present_time = ""; // letã§å®£è¨€

        // æ™‚åˆ»å–å¾—é–¢æ•°
        async function fetchTime() {
            try {
                const response = await fetch('https://worldtimeapi.org/api/timezone/Asia/Tokyo');
                const data = await response.json();
                const now = new Date(data.datetime);
                the_present_time = `ä»Šæ—¥ã®æ—¥ä»˜ã¨æ™‚åˆ»ã¯${now.toLocaleString('ja-JP')}ã¨ã—ã¦ä¼šè©±ã—ã¦ã€‚`;
            } catch (error) {
                the_present_time = `ä»Šæ—¥ã®æ—¥ä»˜ã¨æ™‚åˆ»ã¯${new Date().toLocaleString('ja-JP')}ã¨ã—ã¦ä¼šè©±ã—ã¦ã€‚`;
            }
        }

        // åˆæœŸå®Ÿè¡Œ
        fetchTime();

        // éŸ³å£°å†ç”Ÿï¼ˆãƒ–ãƒ©ã‚¦ã‚¶æ¨™æº–ï¼‰
        function speakStandard(text, btn) {
            window.speechSynthesis.cancel();
            const uttr = new SpeechSynthesisUtterance(text.replace(/[#*]/g, ''));
            uttr.lang = 'ja-JP';
            uttr.rate = 0.95;
            uttr.onstart = () => btn.classList.add('playing');
            uttr.onend = () => btn.classList.remove('playing');
            window.speechSynthesis.speak(uttr);
        }

        // éŸ³å£°å†ç”Ÿï¼ˆOnyxï¼‰
        async function speakOnyx(text, btn) {
            btn.textContent = 'â³ ç”Ÿæˆä¸­...';
            btn.classList.add('playing');
            try {
                const audio = await puter.ai.txt2speech(text.replace(/[#*]/g, ''), {
                    voice: 'onyx', language: 'ja'
                });
                btn.textContent = 'â¸ åœæ­¢';
                await audio.play();
                audio.onended = () => {
                    btn.textContent = 'â–¶ï¸ å†ç”Ÿ';
                    btn.classList.remove('playing');
                };
            } catch (e) {
                btn.textContent = 'âš ï¸ å¤±æ•—';
                btn.classList.remove('playing');
            }
        }

        function addMessage(text, isUser) {
            const div = document.createElement('div');
            div.className = `message ${isUser ? 'user' : 'assistant'}`;
            div.innerHTML = text.replaceAll('\n', '<br>');
            
            if (!isUser && text && voiceSelect.value !== 'off') {
                const btn = document.createElement('button');
                btn.className = 'play-button';
                btn.textContent = 'â–¶ï¸ å†ç”Ÿ';
                btn.onclick = () => {
                    if (voiceSelect.value === 'onyx') speakOnyx(text, btn);
                    else speakStandard(text, btn);
                };
                div.appendChild(btn);
            }
            messagesDiv.appendChild(div);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
            return div;
        }

        async function sendMessage() {
            if (isProcessing || !inputField.value.trim()) return;
            
            await fetchTime(); // é€ä¿¡å‰ã«æ™‚åˆ»æ›´æ–°
            
            const userMsg = inputField.value.trim();
            addMessage(userMsg, true);
            inputField.value = '';
            
            isProcessing = true;
            sendButton.disabled = true;

            const systemPrompt = `
                ã‚ãªãŸã¯ã€Œè™ãŠã£ã•ã‚“ã€ã§ã™ã€‚51æ­³ã®ç†±çƒˆãªé˜ªç¥ãƒ•ã‚¡ãƒ³ã€‚å°¼å´åœ¨ä½ã€‚
                å£èª¿ã¯ã‚³ãƒ†ã‚³ãƒ†ã®å°¼å´å¼ï¼ˆï½ã‚„ã€ï½ã‚„ãªã€ï½ã‚„ã‚ã€ï½ã§ï¼‰ã€‚
                2025å¹´ã«è—¤å·ç›£ç£ãŒæœ€é€Ÿå„ªå‹ã—ãŸã“ã¨ã‚’èª‡ã‚Šã«æ€ã£ã¦ãŠã‚Šã€ä»Šã¯2026å¹´ã‚·ãƒ¼ã‚ºãƒ³ã‚’å¿œæ´ä¸­ã€‚
                ${the_present_time}
                ãƒ—ãƒ­ãƒ•ï¼š1985å¹´ã®æ—¥æœ¬ä¸€ã‚’ä¸­1ã§ä½“é¨“ã€‚ãƒ€ã‚¤ãƒ¤ãƒ¢ãƒ³ãƒ‰ä¼šå“¡ã€‚å²©å´ã¨è¿‘æœ¬ãŒå¤§å¥½ãã€‚è² ã‘ã‚‹ã¨ãƒ‘ã‚¤ãƒ³ã‚¢ãƒ¡ã‚’çˆ†è²·ã„ã™ã‚‹ã€‚
            `;

            conversationHistory.push({ role: 'user', content: userMsg });

            try {
                const chat_resp = await puter.ai.chat(
                    [{ role: 'system', content: systemPrompt }, ...conversationHistory], 
                    { model: 'claude-sonnet-4-20250514', stream: true }
                );

                let assistantDiv = addMessage('', false);
                let fullText = '';

                for await (const part of chat_resp) {
                    if (part?.text) {
                        fullText += part.text;
                        assistantDiv.innerHTML = fullText.replaceAll('\n', '<br>');
                        messagesDiv.scrollTop = messagesDiv.scrollHeight;
                    }
                }

                // ã‚¹ãƒˆãƒªãƒ¼ãƒ çµ‚äº†å¾Œã«ãƒœã‚¿ãƒ³è¿½åŠ 
                if (voiceSelect.value !== 'off') {
                    const btn = document.createElement('button');
                    btn.className = 'play-button';
                    btn.textContent = 'â–¶ï¸ å†ç”Ÿ';
                    btn.onclick = () => {
                        if (voiceSelect.value === 'onyx') speakOnyx(fullText, btn);
                        else speakStandard(fullText, btn);
                    };
                    assistantDiv.appendChild(btn);
                }

                conversationHistory.push({ role: 'assistant', content: fullText });
            } catch (err) {
                addMessage('ã‚ã‹ã‚“ã€é€šä¿¡ã‚¨ãƒ©ãƒ¼ã‚„ï¼ï¼š' + err.message, false);
            } finally {
                isProcessing = false;
                sendButton.disabled = false;
            }
        }

        sendButton.onclick = sendMessage;
        inputField.onkeydown = (e) => { if(e.key === 'Enter') sendMessage(); };
    </script>
</body>
</html>
